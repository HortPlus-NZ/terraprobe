<!-- templates/report_eoy.html -->
{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}
<style>
@media print
{
    @page
    {
        size: landscape;
    }
}
.highcharts-figure-season-graph {
    /*position: absolute;
    top: 10%;
    left: 6%;*/
}


</style>
<form method="post" id="eoyReportForm" data-sites-url="{% url 'ajax_load_sites' %}" novalidate>
    {% csrf_token %}
<div class="container-sm">
    <div class="row selector">
        &emsp;<div class="col-sm-3 form-control-sm">
            {{ form.farm|as_crispy_field }}
        </div>
        <div class="col-sm-3 form-control-sm">
            {{ form.season|as_crispy_field }}
        </div>
    </div>
</div>
</form>
<div class="card" id="report">

</div>

<!--{% for data in eoy_data.eoy_data %} <p>-{{ data }}- - {{ data.rainfall }} {{ counter }}</p> {% endfor %}-->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/solid-gauge.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

<script>
$(document).ready(function(){

    $("#id_farm").change(function() {
        //var url = $("#eoyReportForm").attr("data-sites-url");
        //console.log("URL:" + url);
        var farm_id = $(this).val();  // get the selected technician ID from the HTML input
        var season_id = $("#id_season").val();
        console.log("farm_id:" + farm_id);
        $.ajax({
            url: "/api/eoy_farm_report/" + farm_id + "/" + season_id + "/",
            dataType: 'json',
            success: function(result) { // `data` is the return of the `load_cities` view function
            $("#report").empty();
            console.log(result);

            result.forEach(function(d) {
                $("#report").append("<div class='card-header'><h4>" + d.season + " - " + d.farm +
                    "      " + d.site + " Site : (" + d.site_number + ")&emsp;&emsp;<img style='width: 170px; height: 28px;'src='{% static 'skeleton/images/fruition_logo.png' %}'/></h4></div>")
                $("#report").append("<div class='card-header'>Seasonal Summary and Strategy&emsp;&emsp;&emsp;&emsp;&emsp;Rootzone: 0-" +
                    d.rz1 + " cm&emsp;&emsp;&emsp;&emsp;Soil Classification: " + d.soil_type + "</div>")

                /////////////////////////////////////// Start Season Graph ///////////////////////////////////
                var parseTime = d3.timeParse("%d-%m-%Y");
                var formatTime = d3.timeFormat("%d-%m-%Y");

                var reading_data = [];
                var strategy_area_data = [];
                var rainfall_data = [];
                var irrigation_data = [];
                var critical_data = {};
                var fullpoint = 0;
                var refill = 0;
                var minReading = undefined;
                var maxReading = undefined;

                period_from = moment(d.period_from);
                period_to = moment(d.period_to);
                parameter_string = d.site_id + '/' + period_from.format('DD-MM-YYYY') + '/' + period_to.format('DD-MM-YYYY');

                var row = '';
                row_id = 'row-' + d.site_id + "-graph";
                row += "<div class='card-body'><div class='row' id='" + row_id + "'></row></div>"
                $("div[id='report']").append(row);
                var chart_name = 'season-graph-' + d.site_id;
                content = '';
                content += "<figure class='highcharts-figure-season-graph'>"
                content += "<div id='" + chart_name + "' class='chart-season-graph'></div></figure>"
                $("div[id='" + row_id + "']").append(content);

                d3.json('/graphs/api/vsw_reading/' + parameter_string + '/?format=json').then(function(data) {
                    d3.json('/graphs/api/vsw_strategy/' + parameter_string + '/?format=json').then(function(strategy_data) {

                        data.forEach(function(reading) {

                            parsed_date = parseTime(reading.date);
                            if (reading.reading_type.name == "Probe") {
                                rz1 = Math.round(reading["rz1"]);
                                reading_data.push({
                                    x : parsed_date,
                                    y : rz1
                                });
                                rainfall_data.push({
                                    x : parsed_date,
                                    y : reading.rain
                                });
                                irrigation_data.push({
                                    x : parsed_date,
                                    y : reading.irrigation_mms
                                });
                                if (minReading === undefined || rz1 < minReading)
                                    minReading = rz1;
                                if (maxReading === undefined || rz1 > maxReading)
                                    maxReading = rz1;
                            } else if (reading.reading_type.name == "Full Point") {
                                fullpoint = Math.round(reading["rz1"]);
                            } else if (reading.reading_type.name == "Refill") {
                                refill = Math.round(reading["rz1"]);
                            }
                        }); // End loop of reading data

                        diff = fullpoint - refill;

                        strategy_data.forEach(function(strategy) {
                            critical_data[strategy.critical_date_type] = strategy.critical_date;

                            var strategyDate = parseTime(strategy.strategy_date);
                            var upper = fullpoint - (diff - diff * strategy.percentage);

                            strategy_area_data.push({
                                x: strategyDate,
                                high: upper,
                                low: upper - diff * 0.5
                            });
                        }); // End strategy data loop

                        // Sort by date (x) implicitly, dont rely on api call being in date order
                        strategy_area_data.sort((a, b) => a.x - b.x);
                        reading_data.sort((a, b) => a.x - b.x);
                        rainfall_data.sort((a, b) => a.x - b.x);
                        irrigation_data.sort((a, b) => a.x - b.x);

                        maxY = 0;
                        minY = 0;
                        if (maxReading >= fullpoint){ maxY = maxReading } else { maxY = fullpoint }
                        if (minReading <= refill){ minY = minReading } else { minY = refill }

                        var options = {
                            exporting: { enabled: false },
                            title: null,
                            credits: { enabled: false },
                            chart: {
                                title: 'Season',
                                renderTo: 'season-graph',
                                type: 'area',
                                height: 250,
                                width: 900
                            },
                            xAxis: {
                              type: 'datetime',
                              plotLines: [],
                            },
                            yAxis: [{
                                title: { text: 'Soil Water Content (mm)' },
                                min: minY,
                                max: maxY,
                                plotLines: [{
                                  value: fullpoint,
                                  color: 'green',
                                  width: 2,
                                  label: { text: 'Full Point' },
                                },
                                {
                                  value: refill,
                                  color: 'red',
                                  width: 2,
                                  label: { text: 'Refill' },

                                }],
                            },
                            {
                                title: { text: 'Rain (mm)' },
                                opposite: true
                            }],
                            plotOptions: {
                              series: {
                                states: {
                                  inactive: {
                                    opacity: 1
                                  }
                                }
                              },
                              column: {
                                pointPadding: 0,
                                groupPadding: 0
                              }
                            },
                            series: [
                                {
                                  name: 'Readings',
                                  type: 'line',
                                  data: reading_data,
                                  yAxis: 0,
                                  color: 'black',
                                  marker: {
                                    enabled: true,
                                    symbol: 'circle',
                                    fillColor: 'black'
                                  },
                                  tooltip: {
                                    valueSuffix: ' mm',
                                    valueDecimals: 1
                                  }
                              },
                              {
                                name: 'Strategy',
                                type: 'arearange',
                                data: strategy_area_data,
                                yAxis: 0,
                                marker: {
                                  enabled: false
                                },
                                color: '#9dc8f1',
                                fillOpacity: 0.5,
                                tooltip: {
                                  valueSuffix: ' mm',
                                  valueDecimals: 1
                                }
                              },
                        ]}; // end options
                        options.xAxis.plotLines = [];
                        for (const criticalDateType in critical_data) {
                            options.xAxis.plotLines.push({
                                value: parseTime(critical_data[criticalDateType]),
                                label: { text: criticalDateType }
                            });
                        }

                        options.series.push({
                          name: 'Rainfall',
                          type: 'column',
                          color: 'blue',
                          data: rainfall_data,
                          yAxis: 1,
                          tooltip: {
                            valueSuffix: ' mm',
                            valueDecimals: 1
                          }
                        },
                        {
                          name: 'Irrigation',
                          type: 'column',
                          color: 'red',
                          data: irrigation_data,
                          yAxis: 1,
                          tooltip: {
                            valueSuffix: ' mm',
                            valueDecimals: 1
                          }
                        })

                        var chart = new Highcharts.Chart(chart_name, options)

                    }); // End json strategy call
                }); // End json reading call

                /////////////////////////////////////// End Season Graph ////////////////////////////////////////////

                // We need rows of highcharts gauges. So each row needs a unique identifier of site id and season eg row-238-2020-2021
                var row = '';
                row_id = 'row-' + d.site_id;
                row += "<div class='card-body'><div class='row' id='" + row_id + "'></row></div>"
                $("div[id='report']").append(row)
                var gauges = {
                    rain : {
                        title: "Season's Rainfall",
                        blurb: "<b>How does your block compare?</b><br/><p>Here's how the " + d.season + " season rainfall compares<br/> with the previous 10 seasons.</p>",
                    },
                    eff_irrigation: {
                        title: 'Irrigation Efficency (Site)',
                        blurb: "Here's how effective your irrigation for<br/> the season has been. Effective irrigation<br/> is the % of irrigation applied <br/>" +
                            "that remains in the effective <br/>rootzone and is used by the tree."
                    },
                    average_eff_irrigation: {
                        title: 'Irrigation Efficency (Comparison)',
                        blurb:  "Here's how effective your irrigation for<br/> the season has been. Effective irrigation<br/> is the % of irrigation applied <br/>" +
                            "that remains in the effective <br/>rootzone and is used by the tree."
                    }
                };

                // Loop thrugh the gauges we are going to display
                for (var key in gauges) {

                    var gauge_name = key + '-' + d.site_id; // this is unique for each gauge/chart eg. irrigation_mms-238-2020-2021
                    var gauge_data = d[key]
                    var gauge_data_diff = d[key + '_diff'];
                    var gauge_data_perc = d[key + '_perc'];

                    content = '';
                    content += "<figure class='highcharts-figure-season-gauges'>"
                    content += "<div id='" + gauge_name + "' class='chart-season-gauges'></div></figure>"
                    $("div[id='" + row_id + "']").append(content);

                    // Start Gauge Options //
                    gaugeOptions = {
                        exporting: { enabled: false },
                        chart: {
                            type: 'solidgauge',
                            height: 200,
                            width: 300
                        },
                        title: null,
                        pane: {
                            centre: ['10', '120'],
                            size: '120',
                            startAngle: -90,
                            endAngle: 90,
                            background: {
                                backgroundColor:
                                    Highcharts.defaultOptions.legend.backgroundColor || '#EEE',
                                innerRadius: '60%',
                                outerRadius: '100%',
                                shape: 'arc'
                            }
                        },
                        // the value axis
                        yAxis: {
                            // Where the colour changes
                            stops: [
                                [0.5, 'red'], // green
                                [0.75, 'orange'], // yellow
                                [0.99, 'green'] // red
                            ],
                            lineWidth: 2,
                            tickWidth: 2,
                            minorTickInterval: null,
                            tickAmount: 2,
                            title: {
                                y: -70
                            },
                            labels: {
                                y: 9
                            }
                        },

                        plotOptions: {
                            solidgauge: {
                                dataLabels: {
                                    y: 5,
                                    borderWidth: 0,
                                    useHTML: true
                                }
                            }
                        }
                    }; // End Gauge Options

                    /////////////////////////////////////////////////////////////
                    var gaugeChart = Highcharts.chart(gauge_name, Highcharts.merge(gaugeOptions, {
                        yAxis: {
                            min: 0,
                            max: 100,
                            title: {
                                text: gauges[key].title,
                                align: 'low',
                                textAlign: 'center',
                                style: {
                                    color: 'blue',
                                    'font-weight': 'bold',
                                    'font-size': '14px'
                                }
                            }
                        },

                        credits: { enabled: false },

                        series: [{
                            data: [gauge_data_perc],
                            dataLabels: {
                                allowOverlap: true,
                                format:
                                    '<div style="text-align:centre">' +

                                    '<span style="font-size:18px;text-align:centre;">{y}%</span><br/>' +
                                    '<span style="font-size:12px;font-weight:lighter;">' + gauges[key].blurb + '</span>' +
                                    '</div>'
                            },
                        }]
                    })); // End Gauge Chart
                } // End loop of Gauges
                /////////////////////////////////////// End Gauges ////////////////////////////////////////////

                /////////////////////////////////////// Start Season Summary ////////////////////////////////////////////



                var summary_name = 'season-summary-' + d.site_id;
                var row = '';
                row_id = 'row-' + d.site_id + "-season-summary";
                row += "<div class='card-body'><div class='row' id='" + row_id + "'></row></div>"
                $("div[id='report']").append(row);
                /*$("div[id='" + row_id + "']").append("<p><b>How does your block compare?</b><br />" +
                    "Here's how your seasonal water usage compares against other blocks with the same crop and a similar soil type for the " +
                    d.season + " season.<br /></p>");*/
                content = '';
                content += "<figure class='highcharts-figure-season-summary'>"
                content += "<div id='" + summary_name + "' class='chart-season-summary'></div></figure>"
                $("div[id='" + row_id + "']").append(content);

                /////////////////////////////////////// End Season Summary ////////////////////////////////////////////

                var summary_title = "<b>How does your block compare?</b><br />" +
                    "Here's how your seasonal water usage compares against other blocks with the same crop and a similar soil type for the " +
                    d.season + " season.<br /></p>";
                var summary_caption = "<i>Data based on supplied irrigation system specifications:</i> <b>" + d.application_rate + " L/plant/Hr</b>";

                var season_summary_options = {
                    exporting: { enabled: false },
                    title: { text: summary_title},
                    credits: { enabled: false },
                    chart: { type: 'bar',
                        renderTo: 'season-summary',
                        height: 250,
                        width: 700
                    },
                    legend: { enabled: false },
                    xAxis: {
                        categories: ['You', 'Similar Sites'],
                        title: { text: null },
                        labels: {
                            style: {
                                fontSize: "14px",
                            }
                        }
                    },
                    yAxis: {
                        title: {
                            text: summary_caption,
                            textAlign: 'center',
                            style: {
                                'font-size': '14px'
                            },
                        },
                        min: 100,
                        visible: true,
                    },
                    plotOptions: {
                        bar: {
                            dataLabels: {
                                enabled: true,
                                format: '<b>{y} liters</b>',
                            }
                        }
                    },
                    series: [{
                        name: null,
                        data: [
                            ['You', d.irrigation_mms],
                            ['Similar Sites', d.average_eff_irrigation],
                        ],
                    }],
                }
                var season_summary_chart = new Highcharts.Chart(summary_name, season_summary_options)
            }); // End loop of data
        }
    });
}); // End onchange farm
});
</script>

{% endblock content %}
