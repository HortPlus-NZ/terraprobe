<!-- templates/vsw_percentage.html -->

{% load static %}
{% block content %}

<h5 align="center">{{ title }} Reading date: {{ date }} Period From: {{ period_from }} Period To: {{ period_to }}</h5>

<div class="row">
    <div class="col-4" id="weekly"></div>
    <div class="col-1">
        <svg id="legend" height=300 width=200></svg>
    </div>
    <div class="container col-7">
    <div class="row">
    <div class="col-6" id="area3">
        <table id="last-week-data" class="table table-sm table-bordered">
            <thead class="thead-light">
            <tr>
                <th colspan="4">Amount Received Last Week</th>
            </tr>
            <tr>
                <td></td>
                <td>mm/plant</td>
                <td>Litres/plant</td>
                <td>Hours</td>
            </tr>
            <tr>
                <td>Irrigation</td>
                <td class="mms-plant"></td>
                <td class="litres-plant"></td>
                <td class="hours"></td>
            </tr>
            <tr>
                <td>Rain (mm)</td>
                <td class="previous-rain"></td>
                <td>Root Zone</td>
                <td class="root-zone">cm</td>
            </tr>
            <tr>
                <td>Estimated 7 day water use</td>
                <td class="estimated-dwu"></td>
            </tr>
        </table>
        <table id="season-data" class="table table-sm table-bordered">
            <thead class="thead-light">
            <tr>
                <th colspan="4">Season To Date mm</th>
            </tr>
            <tr>
                <td>Irrigation</td>
                <td class="std-irrigation"></td>
                <td>Rain</td>
                <td class="std-rain"></td>
            </tr>
        </table>
    </div>
    <div class="col-6" id="area4">
        <form>
            <textarea class="form-control form-control-sm" rows="3" id="reading-recommendation-text" readonly></textarea>
            <div id='week-day-labels' class="input-group">
                <input type="text" class="form-control" id="Mon-label" placeholder="Mon" readonly>
                <input type="text" class="form-control" id="Tue-label" placeholder="Tue" readonly>
                <input type="text" class="form-control" id="Wed-label" placeholder="Wed" readonly>
                <input type="text" class="form-control" id="Thu-label" placeholder="Thu" readonly>
                <input type="text" class="form-control" id="Fri-label" placeholder="Fri" readonly>
                <input type="text" class="form-control" id="Sat-label" placeholder="Sat" readonly>
                <input type="text" class="form-control" id="Sun-label" placeholder="Sun" readonly>
            </div>
            Hours
            <div id='week-days' class="input-group">
                <input type="text" class="form-control" id="Mon" placeholder="Mon" readonly>
                <input type="text" class="form-control" id="Tue" placeholder="Tue" readonly>
                <input type="text" class="form-control" id="Wed" placeholder="Wed" readonly>
                <input type="text" class="form-control" id="Thu" placeholder="Thu" readonly>
                <input type="text" class="form-control" id="Fri" placeholder="Fri" readonly>
                <input type="text" class="form-control" id="Sat" placeholder="Sat" readonly>
                <input type="text" class="form-control" id="Sun" placeholder="Sun" readonly>
             </div>
             mm
             <div id='week-days-water' class="input-group">
                 <input type="text" class="form-control" id="Mon-water" readonly>
                 <input type="text" class="form-control" id="Tue-water" readonly>
                 <input type="text" class="form-control" id="Wed-water" readonly>
                 <input type="text" class="form-control" id="Thu-water" readonly>
                 <input type="text" class="form-control" id="Fri-water" readonly>
                 <input type="text" class="form-control" id="Sat-water" readonly>
                 <input type="text" class="form-control" id="Sun-water" readonly>
             </div>
         </form>
    </div>
    <div class="col-8" id="area5">
       <iframe id="widget-iframe" width="1100" height="125" src="/weather" allowtransparency="true" style="border:none"></iframe>
   </div>
    </div>
    </div>


</div>
<div class="row">
    <div class="col" id="seasonal"></div>
    <div class="col" id="alert-box">
        <textarea id="site-note" rows="4" cols="30" style="border:2px solid red;" readonly>
        </textarea>
    </div>
</div>

<script>

var parseTime = d3.timeParse("%d-%m-%Y");
var formatTime = d3.timeFormat("%d-%m-%Y");

// assemble reading date and previous reading date into this and last weeks dates javascript dates. Time does not matter
// js is a bitch extract on '-' for date 25-03-2019
var date = "{{ date }}";
var this_week_date = parseTime(date);
var split_date = date.split("-");
var this_week_date_test = new Date(split_date[2], split_date[1] - 1, split_date[0]);

console.log("***This week DATE:" + this_week_date);

var previous = "{{ previous }}";
var last_week_date = parseTime(previous);
console.log('***Last Week DATE:' + last_week_date);

// set the dimensions and margins of the weekly graph
var margin = {top: 35, right: 30, bottom: 30, left: 40};
width = 600 - margin.left - margin.right;
height = 350 - margin.top - margin.bottom;

// set the dimensions and margins of the season graph
//var season_margin = {top: 500, right: 20, bottom: 30, left: 50};
season_width = 1400 - margin.left - margin.right;
season_height = 420 - margin.top - margin.bottom;

// set the weekly ranges
var weekly_x = d3.scaleLinear().range([0, width]);
var weekly_y = d3.scaleLinear().range([0, height]);

// set the season ranges
var seasonx = d3.scaleTime().range([0, season_width]); //date
var seasony0 = d3.scaleLinear().range([season_height, 0]);
var seasony1 = d3.scaleLinear().range([season_height, 0]);

// The scale spacing the groups:
var x0 = d3.scaleBand()
    .range([0, season_width])
    .paddingInner(0.3);

// The scale for spacing each group's bar:
var x1 = d3.scaleBand()
    .padding(0.7);

var z = d3.scaleOrdinal()
    .range(["red", "blue"]);

var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

/******************** Weekly Graph Lines *********************/

var vswline = d3.line()
    .x(function(r) { return weekly_x(r.vsw); })
    .y(function(r) { return weekly_y(r.depth); });

var previous_vswline = d3.line()
    .x(function(r) { return weekly_x(r.vsw); })
    .y(function(r) { return weekly_y(r.depth); });

var refill_line = d3.line()
    .x(function(r) { return weekly_x(r.vsw); })
    .y(function(r) { return weekly_y(r.depth); });

var full_point_line = d3.line()
    .x(function(r) { return weekly_x(r.vsw); })
    .y(function(r) { return weekly_y(r.depth); });

var weekly_graph = d3.select("#weekly").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

/******************** Season Graph Lines *********************/

var season_vswline0 = d3.line()
    .x(function(r) { return seasonx(r.date); })
    .y(function(r) { return seasony0(r.total); });

var season_upper_strategy_line = d3.line()
    .x(function(r) { return seasonx(r.date); })
    .y(function(r) { return seasony0(r.total); });

var season_lower_strategy_line = d3.line()
    .x(function(r) { return seasonx(r.date); })
    .y(function(r) { return seasony0(r.total); });

var season_full_point_line = d3.line()
    .x(function(r) { return seasonx(r.date); })
    .y(function(r) { return seasony0(r.total); });

var season_refill_line = d3.line()
    .x(function(r) { return seasonx(r.date); })
    .y(function(r) { return seasony0(r.total); });

var season_graph = d3.select("#seasonal").append("svg")
    .attr("width", season_width + margin.left + margin.right)
    .attr("height", season_height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

// Weeks readings arrays
var vsw_readings = [];
var previous_vsw_readings = [];
var full_point_readings = [];
var refill_readings = [];

// Seasons readings arrays
var seasons_vsw_readings = [];
var seasons_full_point_readings = []
var seasons_refill_readings = []
var seasons_upper_strategy = []
var seasons_lower_strategy = []

var season_grouping = [];
vsw_count = 10; // delivered by vsw_reading api
var full_point_rz1 = 0;
var refill_rz1 = 0;

var season_critical_dates = {};

// Recommedations
var previous_rain = 0;
var previous_hours_irrigation = 0;
var previous_mms_plant = 0;
var previous_litres_plant = 0;
var std_irrigation = 0;
var std_rain = 0;
var root_zone = '0 - ';
var estimated_dwu = 0;
var recommendation_text = '';
var rec_mon = 0, rec_tue = 0, rec_wed = 0, rec_thu = 0, rec_fri = 0, rec_sat = 0, rec_sun = 0;

function sortByDateAscending(a, b) {
    // Dates will be cast to numbers automagically:
    return a.date - b.date;
}

d3.json('/graphs/api/vsw_reading/' + "{{ site_id }}" + '/' + "{{ period_from }}" + '/' + "{{ period_to }}" + '/?format=json').then(function(data) {
    // Get strategies

    d3.json('/graphs/api/vsw_strategy/' + "{{ site_id }}" + '/' + "{{ period_from }}" + '/' + "{{ period_to }}" + '/?format=json').then(function(strategy_data) {
        strategy_data.forEach(function(strategy) {
            season_critical_dates[strategy.critical_date_type] = parseTime(strategy.critical_date);

            parsed_date = parseTime(strategy.strategy_date);
            seasons_upper_strategy.push({
                'date' : parsed_date,
                'percentage' : strategy.percentage
            });

            // Fill
            seasons_lower_strategy.push({
                'date' : parsed_date,
                'percentage' : 0
            });
        });

    vsw_readings_date_array = []; // This is better to use for refill and full point full_point_readings

    data.forEach(function(reading) {

        parsed_date = parseTime(reading.date);
        // get seasons_vsw percentage readings for Probe
        if (reading.reading_type.name == "Probe") {
            parsed_date = parseTime(reading.date);
            seasons_vsw_readings.push({
                'date' : parsed_date,
                'total' : Math.round(reading["rz1"]),
            });
            // Seasons Groupiong
            season_grouping.push({
                'date' : parsed_date,
                'rain' : reading["rain"],
                'irrigation_mms' : reading["irrigation_mms"],
            });

            vsw_readings_date_array.push(parsed_date)

            // Season to Date figures
            std_irrigation += reading["irrigation_litres"]
            std_rain += reading["rain"]

            if (this_week_date.toDateString() == parsed_date.toDateString()) {
                console.log("** Reading Date:" + parsed_date + " This week date:" + this_week_date)
                for (index = 1; index <= vsw_count; index++) {
                    if (reading["depth" + index] !== null) {
                        vsw_readings.push({
                            'depth' : reading["depth" + index],
                            'vsw' : reading["vsw" + index + '_perc'],
                        })
                    } else {
                        console.log("where null");
                    }
                } // end for loop
                // get recommendation and other data for this week
                recommendation_text = reading["comment"]
                rec_mon = reading["rec_mon"]
                rec_tue = reading["rec_tue"]
                rec_wed = reading["rec_wed"]
                rec_thu = reading["rec_thu"]
                rec_fri = reading["rec_fri"]
                rec_sat = reading["rec_sat"]
                rec_sun = reading["rec_sun"]
                //"rec_mon":0.0,"rec_tue":0.0,"rec_wed":2.0,"rec_thu":2.6,"rec_fri":0.0,"rec_sat":0.0

            }

            // Get last weeks readings
            if (last_week_date.toDateString() == parsed_date.toDateString()) {
                for (index = 1; index <= vsw_count; index++) {
                    if (reading["depth" + index] !== null) {
                        previous_vsw_readings.push({
                            'depth' : reading["depth" + index],
                            'vsw' : reading["vsw" + index + '_perc'],
                        })
                    }
                } // end for loop
                /* Calculate values for Amounts Recieved last Week */
                previous_litres_plant = reading["irrigation_litres"];
                previous_mms_plant = reading["irrigation_mms"];
                previous_rain = reading["rain"];
                root_zone += reading["rz1_bottom"] + ' cm';
                estimated_dwu = Math.round(reading["estimated_dwu"] * 7);
                application_rate = reading["site"]["application_rate"];
                site_note = reading["site"]["site_note"];
                previous_hours_irrigation = Math.round(previous_mms_plant / application_rate);
            }
        }

        // Get the Full Point and Refill - These are the vsw figures
        if (reading.reading_type.name == "Full Point") {
            for (index = 1; index <= vsw_count; index++) {
                if (reading["depth" + index] !== null) {
                    full_point_readings.push({
                        'depth' : reading["depth" + index],
                        'vsw' : reading["vsw" + index],
                    });
                }
            }
            full_point_rz1 = Math.round(reading["rz1"]);
        }

        if (reading.reading_type.name == "Refill") {
            for (index = 1; index <= vsw_count; index++) {
                if (reading["depth" + index] !== null) {
                    refill_readings.push({
                        'depth' : reading["depth" + index],
                        'vsw' : reading["vsw" + index],
                    });
                }
            }
            refill_rz1 = Math.round(reading["rz1"]);
        }
    });

    // Seasons Refill - This is the rz1 value for each proble reading date
    for (index = 0; index < vsw_readings_date_array.length; index++) {
        seasons_refill_readings.push({
            'date' : vsw_readings_date_array[index],
            'total' : refill_rz1
        });
        seasons_full_point_readings.push({
            'date' : vsw_readings_date_array[index],
            'total' : full_point_rz1
        });
    }

    /* need to sort arrays by date */
    seasons_vsw_readings = seasons_vsw_readings.sort(sortByDateAscending);

    // TODO: Do this better. Need to test if site actually has a strategy
    if (seasons_upper_strategy.length > 0) {
        console.log('start reading date' + seasons_refill_readings[0]['date'])
        // First date of both strategies will be season start date (period from)
        seasons_upper_strategy.push({
            'date' : seasons_vsw_readings[0]['date'],
            'percentage' : 1
        });
        seasons_lower_strategy.push({
            'date' : seasons_vsw_readings[0]['date'],
            'percentage' : 0
        });

        diff = full_point_rz1 - refill_rz1

        new_seasons_lower_strategy = [];
        // replace all lowere with upper - diff
        for (var i = 0; i < seasons_upper_strategy.length; i++) {
            // $C$3-($F$3-($F$3*E8))
            upper_total = full_point_rz1 - (diff - (diff * seasons_upper_strategy[i]['percentage']))

            lower_total = upper_total - ( diff * .5 )
            seasons_upper_strategy[i]['total'] = upper_total;
            seasons_lower_strategy[i]['date'] = seasons_upper_strategy[i]['date'];
            seasons_lower_strategy[i]['total'] = lower_total;
        }
    }
    seasons_upper_strategy = seasons_upper_strategy.sort(sortByDateAscending);
    seasons_lower_strategy = seasons_lower_strategy.sort(sortByDateAscending);

    season_grouping  = season_grouping.sort(sortByDateAscending);
    console.log('previous_vsw_readings');
    console.log(previous_vsw_readings.length);



    // Scale the range of the data
    var min_weekly_x = refill_readings.concat(vsw_readings).concat(previous_vsw_readings);
    weekly_x.domain([d3.min(min_weekly_x, function(r) { return r.vsw - 2; }), d3.max(full_point_readings, function(r) { return r.vsw + 2; })]);
    weekly_y.domain([d3.min(vsw_readings, function(r) { return r.depth - 5; }), d3.max(vsw_readings, function(r) { return r.depth + 5; })]);

    seasonx.domain(d3.extent(seasons_vsw_readings, function(d) { return d.date; }));
    seasony0.domain([d3.min(seasons_vsw_readings, function(d) { return d.total - 40; }), d3.max(seasons_full_point_readings, function(d) { return d.total + 10; })]);

    /*********************** Weekly Graph Shaded Area between This Week and Previous weeks line ********************/
    // We need to get data into arrays for x and y for this week and x for previous week
    var this_week_x = [];
    var this_week_y = [];
    previous_week_x = [];

    for (i=0; i < previous_vsw_readings.length; i++) {
        this_week_y.push(vsw_readings[i].depth);
        this_week_x.push(vsw_readings[i].vsw);
        previous_week_x.push(previous_vsw_readings[i].vsw);
    }

   	var area = d3.area()
    	.x0(function(d) { return weekly_x(this_week_x[d]) })
        .x1(function(d) { return weekly_x(previous_week_x[d]) ; })
      	.y0(function(d) { return weekly_y(this_week_y[d] ); })
      	.y1(function(d) { return weekly_y(this_week_y[d] ); });

    // Append the shaded area to graph
    var indexies = d3.range( this_week_y.length );
    weekly_graph.append("path")
       .datum(indexies)
       .attr("class", "area")
       .attr("d", area);
    /***************************************** End Shaded Area *********************************************************/

    // Add the lines
    weekly_graph.append("path")
      .data([vsw_readings])
      .attr("class", "line")
      .attr("d", vswline);

    weekly_graph.append("path")
      .data([previous_vsw_readings])
      .attr("class", "line")
      .style("stroke-width", "1px")
      .attr("d", previous_vswline);

    // Add the refill line
    weekly_graph.append("path")
      .data([refill_readings])
      .attr("class", "line")
      .style("stroke", "red")
      .attr("d", refill_line);

    // Add the full point line
    weekly_graph.append("path")
      .data([full_point_readings])
      .attr("class", "line")
      .style("stroke", "green")
      .attr("d", full_point_line);

    // Add the scatterplot
    weekly_graph.selectAll("dot")
        .data(vsw_readings)
        .enter().append("circle")
        .attr("r", 5)
        .attr("cx", function(r) { return weekly_x(r.vsw); })
        .attr("cy", function(r) { return weekly_y(r.depth); });

    // Add the X Axis
    weekly_graph.append("g")
      //.attr("transform", "translate(0," + height + ")")
      .call(d3.axisTop(weekly_x));

    weekly_graph.append("text")
      .attr("transform",
            "translate(" + (width/2) + " ," +
                           (0 - 20) + ")")
      .text("VSW (%)");

    // Add the Y Axis
    weekly_graph.append("g")
        .call(d3.axisLeft(weekly_y));

    weekly_graph.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 0 - margin.left)
      .attr("x", 0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .text("Depth (cm)");

    var keys = ['rain', 'irrigation_mms']
    var keys_with_date = ['date', 'rain', 'irrigation_mms']

    x0.domain(season_grouping.map(function(d) { return d.date; }));
    console.log('Bandwidth' + x0.bandwidth())
    x1.domain(keys).rangeRound([0, x0.bandwidth()]);
    seasony1.domain([0, d3.max(data, function(d) { return d3.max(keys, function(key) { return d[key] + 100; }); })])

    /* We use our season critical dates to draw vertical lines. We can have 1..n */
    console.log(season_critical_dates);
    colours = ["navy", "salmon", "orchid", "lime"]
    colour_index = 0;
    for (type in season_critical_dates) {
        colour_index
        var critical_date = season_critical_dates[type];

        season_graph.append("line")
            .attr("x1", seasonx(critical_date))
            .attr("y1", 0)
            .attr("x2", seasonx(critical_date))
            .attr("y2", season_height)
            .style("stroke-width", 2)
            .style("stroke", colours[colour_index])
            .style("fill", "none");

        season_graph.append("text")
           .attr("y", -10)
           .attr("x", seasonx(critical_date))
           .attr('text-anchor', 'middle')
           .attr("class", "myLabel")//easy to style with CSS
           .text(type);
        colour_index++;
    }

    // append the rectangles for the seasonal bar chart
    season_graph.selectAll(".bar")
        .data(season_grouping)
        .enter().append("g")
        .attr("class", "bar")
        .attr("transform", function(d) { return "translate(" + x0(d.date) + ",0)"; })
        .selectAll("rect")
        .data(function(d) {
            return keys.map(function(key) {
                return {
                    key: key,
                    value: d[key]
                };

            });
        }).enter().append("rect")
          .attr("x", function(d) { return x1(d.key); })
          .attr("y", function(d) { return seasony1(d.value); })
          .attr("id", function(d) { return d.key; })
          .attr("width", 3)
          .attr("height", function(d) { return season_height - seasony1(d.value); })
          .on("mouseover", function(d) {
              div.transition()
              .duration(200)
              .style("opacity", .9);
              div.html(d.value)
              .style("left", (d3.event.pageX) + "px")
              .style("top", (d3.event.pageY - 28) + "px");
          })
              .on("mouseout", function(d) {
              div.transition()
              .duration(500)
              .style("opacity", 0);
          })
          .attr("fill", function(d) { return z(d.key); });

    season_graph.append("path")
      .data([seasons_vsw_readings])
      .attr("class", "line")
      .attr("d", season_vswline0);

    season_graph.selectAll("dot")
        .data(seasons_vsw_readings)
        .enter().append("circle")
            .attr("r", 5)
            .attr("cx", function(r) { return seasonx(r.date); })
            .attr("cy", function(r) { return seasony0(r.total); })
            .on("mouseover", function(r) {
                div.transition()
                    .duration(200)
                    .style("opacity", .9);
                div.html(formatTime(r.total) + "<br/>" + r.date)
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
            })
            .on("mouseout", function(r) {
                div.transition()
                    .duration(500)
                    .style("opacity", 0);
            });

    // Full Point Season line. This is just the total of full_point_readings across all dates
    season_graph.append("path")
        .data([seasons_full_point_readings])
        .attr("class", "line")
        .style("stroke", "green")
        .style("stroke-width", "2px")
        .attr("d", season_full_point_line);

    // Refill Season line. This is just the total of refill_readings across all dates
    season_graph.append("path")
        .data([seasons_refill_readings])
        .attr("class", "line")
        .style("stroke", "red")
        .style("stroke-width", "2px")
        .attr("d", season_refill_line);

    season_graph.append("path")
        .data([seasons_upper_strategy])
        .attr("class", "line")
        .style("stroke", "black")
        .style("stroke-dasharray", ("5, 5"))
        .style("stroke-width", "3px")
        .attr("d", season_upper_strategy_line);

    season_graph.append("path")
        .data([seasons_lower_strategy])
        .attr("class", "line")
        .style("stroke", "orange")
        .style("stroke-dasharray", ("5, 5"))
        .style("stroke-width", "3px")
        .attr("d", season_lower_strategy_line);

    // Add Season Graph X Axis
    season_graph.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + season_height + ")")
        .call(d3.axisBottom(seasonx)
            .ticks(d3.timeWeek.every(1))
            .tickFormat(d3.timeFormat("%m-%d")));

    // Add Season Graph Y0 Axis
    season_graph.append("g")
        .attr("class", "axisSteelBlue")
        .call(d3.axisLeft(seasony0));

    // Add Season Graph YBar Axis

    season_graph.append("g")
        .attr("class", "axisRed")
        .attr("transform", "translate( " + season_width + ", 0 )")
        .call(d3.axisRight(seasony1));

    /*************** legend ******************/

        var legend = season_graph.append("g")
          .attr("font-family", "sans-serif")
          .attr("font-size", 10)
          .attr("text-anchor", "end")
        .selectAll("g")
        .data(keys.slice().reverse())
        .enter().append("g")
          .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

      legend.append("rect")
          .attr("x", season_width - 17)
          .attr("width", 15)
          .attr("height", 15)
          .attr("fill", z)
          .attr("stroke", z)
          .attr("stroke-width",2)
          .on("click",function(d) { update(d) });

      legend.append("text")
          .attr("x", season_width - 24)
          .attr("y", 9.5)
          .attr("dy", "0.32em")
          .text(function(d) { return d; });

      // Update recommendation fields
      $("#last-week-data td.mms-plant").html(previous_mms_plant);
      $("#last-week-data td.litres-plant").html(previous_litres_plant);
      $("#last-week-data td.hours").html(previous_hours_irrigation);
      $("#last-week-data td.previous-rain").html(previous_rain);
      $("#last-week-data td.root-zone").html(root_zone);
      $("#last-week-data td.estimated-dwu").html(estimated_dwu);
      $("#season-data td.std-irrigation").html(std_irrigation);
      $("#season-data td.std-rain").html(std_rain);

      //week_start = reading.date.weekday() + 1
      //week_start_abbr = calendar.day_abbr[week_start]
      console.log('Week Start:' + this_week_date_test)
      var week_start = this_week_date_test.getDay();
      console.log('Week Start:' + week_start)
      days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      week_start_abbr = days[week_start];
      console.log('Week Start Abbr:' + week_start_abbr);

      $("textarea#reading-recommendation-text").val(recommendation_text);
      $("textarea#site-note").val(site_note);

      $("input#Mon").val(rec_mon);
      $("input#Tue").val(rec_tue);
      $("input#Wed").val(rec_wed);
      $("input#Thu").val(rec_thu);
      $("input#Fri").val(rec_fri);
      $("input#Sat").val(rec_sat);
      $("input#Sun").val(rec_sun);
      $("input#Mon-water").val(Math.round(application_rate * rec_mon));
      $("input#Tue-water").val(Math.round(application_rate * rec_tue));
      $("input#Wed-water").val(Math.round(application_rate * rec_wed));
      $("input#Thu-water").val(Math.round(application_rate * rec_thu));
      $("input#Fri-water").val(Math.round(application_rate * rec_fri));
      $("input#Sat-water").val(Math.round(application_rate * rec_sat));
      $("input#Sun-water").val(Math.round(application_rate * rec_sun));

      updateReadingRecommendations(week_start_abbr, week_start)

      // Handmade legend
      var svg = d3.select("#legend")
        svg.append("circle").attr("cx",20).attr("cy",80).attr("r", 4).style("fill", "green")
        svg.append("circle").attr("cx",20).attr("cy",100).attr("r", 4).style("fill", "red")
        svg.append("text").attr("x", 30).attr("y", 50).text("Legend").style("font-size", "20px").attr("alignment-baseline","middle")
        svg.append("text").attr("x", 30).attr("y", 80).text("Full Point").style("font-size", "15px").attr("alignment-baseline","middle")
        svg.append("text").attr("x", 30).attr("y", 100).text("Refill").style("font-size", "15px").attr("alignment-baseline","middle")

});

});


</script>

{% endblock content %}
