<!-- templates/vsw_percentage.html -->

{% load static %}
{% block content %}

<h5 align="center">Reading date: {{ date }} Last Week date: {{ previous }} Period From: {{ period_from }} Period To: {{ period_to }}</h3>
<div class="row">
    <div class="col" id="area1"></div>
    <div class="col" id="area3">
        <table class="table table-sm table-bordered">
            <thead class="thead-light">
            <tr>
                <th colspan="4">Current State</th>
            </tr>
            <tr>
                <td colspan="2">Root Zone</td>
                <td colspan="2">00000</td>
            </tr>
            <tr>
                <td>Full</td>
                <td>00000</td>
                <td>Refill</td>
                <td>00000</td>
            </tr>
            <tr>
                <td>Previous</td>
                <td>00000</td>
                <td>Current</td>
                <td>00000</td>
            </tr>
        </table>
        <table class="table table-sm table-bordered">
            <thead class="thead-light">
            <tr>
                <th colspan="4">Amount Received Last Week</th>
            </tr>
            <tr>
                <td></td>
                <td>mm</td>
                <td>L/plant</td>
                <td>Hours</td>
            </tr>
            <tr>
                <td>Irrigation</td>
                <td>00000</td>
                <td>00000</td>
                <td>00000</td>
            </tr>
            <tr>
                <td>Rainfall</td>
                <td>00000</td>
                <td>Crop Use</td>
                <td>00000</td>
            </tr>
        </table>
    </div>
    <div class="col" id="area4">
        <table class="table table-sm table-bordered">
            <thead class="thead-light">
            <tr>
                <th colspan="3">Recommendation</th>
            </tr>
            <tr>
                <td colspan="3">Lorem ipsum dolor sit amet, nibh admodum sententiae ad cum, vero phaedrum in ius, etiam dissentiet te per. Detraxit dissentias sea id. Per oblique th
                </td>
            </tr>
            <tr>
                <td>Recommendations based on:
            </tr>
            <tr>
                <td>Full</td>
                <td>00000</td>
                <td>Refill</td>
            </tr>
            <tr>
                <td>Previous</td>
                <td>00000</td>
                <td>Current</td>

            </tr>
        </table>
    </div>
</div>
<div class="row">
    <div class="col" id="area2"></div>
</div>
<script>
var parseTime = d3.timeParse("%Y-%m-%d");

// assemble reading date and previous reading date into this and last weeks dates javascript dates. Time does not matter
// js is a bitch extract on '-' for date 25-03-2019
var date = "{{ date }}"
var split_date = date.split("-")
var this_week_date = new Date(split_date[2], split_date[1] - 1, split_date[0]).toDateString();
console.log("***This week DATE:" + this_week_date);

var previous = "{{ previous }}";
var split_previous = previous.split("-");
var last_week_date = new Date(split_previous[2], split_previous[1] - 1, split_previous[0]).toDateString();
console.log('***Last Week DATE:' + last_week_date);

// set the dimensions and margins of the weekly graph
var margin = {top: 35, right: 30, bottom: 30, left: 40};
width = 800 - margin.left - margin.right;
height = 350 - margin.top - margin.bottom;

// set the dimensions and margins of the season graph
//var season_margin = {top: 500, right: 20, bottom: 30, left: 50};
season_width = 1500 - margin.left - margin.right;
season_height = 350 - margin.top - margin.bottom;

// set the weekly ranges
var x = d3.scaleLinear().range([0, width]); //vsw (%)
var y = d3.scaleLinear().range([0, height]);

// set the season ranges
var seasonx = d3.scaleTime().range([0, season_width]); //date
var seasony0 = d3.scaleLinear().range([season_height, 0]);
var seasony1 = d3.scaleLinear().range([season_height, 0]);

// The scale spacing the groups:
var x0 = d3.scaleBand()
    .range([0, season_width])
    .paddingInner(0.3);

// The scale for spacing each group's bar:
var x1 = d3.scaleBand()
    .padding(0.7);

var z = d3.scaleOrdinal()
    .range(["red", "blue"]);

    var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);


// define the vsw percentage line
var vswline = d3.line()
    .x(function(r) { return x(r.vsw); })
    .y(function(r) { return y(r.depth); });

var season_vswline0 = d3.line()
    .x(function(r) { return seasonx(r.date); })
    .y(function(r) { return seasony0(r.total); });

// Season Full Point Total
var season_upper_strategy_line = d3.line()
    .x(function(r) { return seasonx(r.date); })
    .y(function(r) { return seasony0(r.total); });

// Season Full Point Total
var season_full_point_line = d3.line()
    .x(function(r) { return seasonx(r.date); })
    .y(function(r) { return seasony0(r.total); });

// Season Refill Total
var season_refill_line = d3.line()
    .x(function(r) { return seasonx(r.date); })
    .y(function(r) { return seasony0(r.total); });

// define previous vsw percentage line
var previous_vswline = d3.line()
    .x(function(r) { return x(r.vsw); })
    .y(function(r) { return y(r.depth); });

// define the refill line
var refill_line = d3.line()
    .x(function(r) { return x(r.vsw); })
    .y(function(r) { return y(r.depth); });

// define the full point line
var full_point_line = d3.line()
    .x(function(r) { return x(r.vsw); })
    .y(function(r) { return y(r.depth); });

var weekly_graph = d3.select("#area1").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

var season_graph = d3.select("#area2").append("svg")
    .attr("width", season_width + margin.left + margin.right)
    .attr("height", season_height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");

// Weeks readings arrays
var vsw_readings = [];
var previous_vsw_readings = [];
var full_point_readings = [];
var refill_readings = [];

// Seasons readings arrays
var seasons_vsw_readings = [];
var seasons_full_point_readings = []
var seasons_refill_readings = []
var seasons_upper_strategy = []
var seasons_lower_strategy = []

var season_grouping = [];
vsw_count = 10; // delivered by vsw_reading api

d3.json('/graphs/api/vsw_reading/' + "{{ site_id }}" + '/' + "{{ period_from }}" + '/' + "{{ period_to }}" + '/?format=json').then(function(data) {
    // Get strategies
    d3.json('/graphs/api/vsw_strategy/' + "{{ site_id }}" + '/' + "{{ period_from }}" + '/' + "{{ period_to }}" + '/?format=json').then(function(strategy_data) {

        strategy_data.forEach(function(strategy) {

            parsed_date = parseTime(strategy.strategy_date);
            console.log('strat date:' + strategy.strategy_date + ' strat vsw:' + strategy.upper_strategy_vsw);
            seasons_upper_strategy.push({
                'date' : parsed_date,
                'total' : strategy.upper_strategy_vsw,
            });
        });
        console.log(seasons_upper_strategy);

    console.log("This Week:" + this_week_date + " Last week:" + last_week_date);
    vsw_readings_date_array = []; // This is better to use for refill and full point full_point_readings

    data.forEach(function(reading) {
        var reading_date = new Date(reading.date).toDateString();

        // get seasons_vsw percentage readings for Probe
        if (reading.reading_type.name == "Probe") {
            parsed_date = parseTime(reading.date);
            seasons_vsw_readings.push({
                'date' : parsed_date,
                'total' : Math.round(reading["rz1"]),
            });
            // Seasons Groupiong
            season_grouping.push({
                'dtg' : parsed_date,
                'rain' : reading["rain"],
                'irrigation_mms' : reading["irrigation_mms"],
            });

            vsw_readings_date_array.push(parsed_date)
            console.log('vsw_readings_date_array:' + vsw_readings_date_array)
            if (this_week_date == reading_date) {
                for (index = 1; index <= vsw_count; index++) {
                    if (reading["depth" + index] !== null) {
                        vsw_readings.push({
                            'depth' : reading["depth" + index],
                            'vsw' : reading["vsw" + index + '_perc'],
                        })
                    } else {
                        console.log("where null");
                    }
                } // end for loop
            }

            // Get last weeks readings
            if (last_week_date == reading_date) {
                for (index = 1; index <= vsw_count; index++) {
                    if (reading["depth" + index] !== null) {
                        previous_vsw_readings.push({
                            'depth' : reading["depth" + index],
                            'vsw' : reading["vsw" + index + '_perc'],
                        })
                    }
                } // end for loop
            }
        }

        // Get the Full Point and Refill - These are the vsw figures
        if (reading.reading_type.name == "Full Point") {
            for (index = 1; index <= vsw_count; index++) {
                if (reading["depth" + index] !== null) {
                    full_point_readings.push({
                        'depth' : reading["depth" + index],
                        'vsw' : reading["vsw" + index],
                    });
                }
            }
            // Seasons Full Point - This is the rz1 value for each proble reading date
            for (index = 0; index < vsw_readings_date_array.length; index++) {
                seasons_full_point_readings.push({
                    'date' : vsw_readings_date_array[index],
                    'total' : Math.round(reading["rz1"]),
                });
            }
        }

        if (reading.reading_type.name == "Refill") {
            for (index = 1; index <= vsw_count; index++) {
                if (reading["depth" + index] !== null) {
                    refill_readings.push({
                        'depth' : reading["depth" + index],
                        'vsw' : reading["vsw" + index],
                    });
                }
            }
            // Seasons Refill - This is the rz1 value for each proble reading date
            for (index = 0; index < vsw_readings_date_array.length; index++) {
                seasons_refill_readings.push({
                    'date' : vsw_readings_date_array[index],
                    'total' : Math.round(reading["rz1"]),
                });
            }
        }
    });

    // Scale the range of the data
    x.domain([5, 50]);
    y.domain([d3.min(vsw_readings, function(r) { return r.depth - 5; }), d3.max(vsw_readings, function(r) { return r.depth + 5; })]);

    seasonx.domain(d3.extent(seasons_vsw_readings, function(d) { return d.date; }));
    seasony0.domain([d3.min(seasons_vsw_readings, function(d) { return d.total - 40; }), d3.max(seasons_full_point_readings, function(d) { return d.total + 10; })]);
    //seasony1.domain([d3.min(seasons_rain, function(d) { return d.rain - 5; }), d3.max(seasons_rain, function(d) { return d.rain + 5; })]);

    // Add the lines
    weekly_graph.append("path")
      .data([vsw_readings])
      .attr("class", "line")
      .attr("d", vswline);

    season_graph.append("path")
        .data([seasons_vsw_readings])
        .attr("class", "line")
        .attr("d", season_vswline0);

    console.log(season_grouping);
    var keys = ['rain', 'irrigation_mms']
    console.log("keys:" + keys);

    x0.domain(season_grouping.map(function(d) { return d.dtg; }));
    x1.domain(keys).rangeRound([0, x0.bandwidth()]);
    seasony1.domain([0, d3.max(data, function(d) { return d3.max(keys, function(key) { return d[key] + 100; }); })])

    // append the rectangles for the seasonal bar chart
    season_graph.selectAll(".bar")
        .data(season_grouping)
        .enter().append("g")
        .attr("class", "bar")
        .attr("transform", function(d) { return "translate(" + x0(d.dtg) + ",0)"; })
        .selectAll("rect")
        .data(function(d) {
            return keys.map(function(key) {
                return {key: key, value: d[key]};
            });
        }).enter().append("rect")
          .attr("x", function(d) { return x1(d.key); })
          .attr("y", function(d) { return seasony1(d.value); })
          .attr("id", function(d) { return d.key; })
          .attr("width", x1.bandwidth())
          .attr("height", function(d) { return height - seasony1(d.value); })
          .on("mouseover", function(d) {
              div.transition()
              .duration(200)
              .style("opacity", .9);
              div.html(d.value)
              .style("left", (d3.event.pageX) + "px")
              .style("top", (d3.event.pageY - 28) + "px");
          })
              .on("mouseout", function(d) {
              div.transition()
              .duration(500)
              .style("opacity", 0);
          })
          .attr("fill", function(d) { return z(d.key); });

    // Full Point Season line. This is just the total of full_point_readings across all dates
    season_graph.append("path")
        .data([seasons_full_point_readings])
        .attr("class", "line")
        .style("stroke", "green")
        .style("stroke-width", "2px")
        .attr("d", season_full_point_line);

    // Refill Season line. This is just the total of refill_readings across all dates
    season_graph.append("path")
        .data([seasons_refill_readings])
        .attr("class", "line")
        .style("stroke", "red")
        .style("stroke-width", "2px")
        .attr("d", season_refill_line);

    season_graph.append("path")
        .data([seasons_upper_strategy])
        .attr("class", "line")
        .style("stroke", "black")
        .style("stroke-width", "3px")
        .attr("d", season_upper_strategy_line);


    weekly_graph.append("path")
        .data([previous_vsw_readings])
        .attr("class", "line")
        .style("stroke-width", "1px")
        .attr("d", previous_vswline);

    // Add the refill line
    weekly_graph.append("path")
        .data([refill_readings])
        .attr("class", "line")
        .style("stroke", "red")
        .attr("d", refill_line);

    // Add the full point line
    weekly_graph.append("path")
        .data([full_point_readings])
        .attr("class", "line")
        .style("stroke", "green")
        .attr("d", full_point_line);

    // Add the scatterplot
    weekly_graph.selectAll("dot")
      .data(vsw_readings)
      .enter().append("circle")
      .attr("r", 5)
      .attr("cx", function(r) { return x(r.vsw); })
      .attr("cy", function(r) { return y(r.depth); });

    // Add the X Axis
    weekly_graph.append("g")
        //.attr("transform", "translate(0," + height + ")")
        .call(d3.axisTop(x));

    weekly_graph.append("text")
        .attr("transform",
              "translate(" + (width/2) + " ," +
                             (0 - 20) + ")")
        .text("VSW (%)");

    // Add the Y Axis
    weekly_graph.append("g")
          .call(d3.axisLeft(y));

    weekly_graph.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left)
        .attr("x", 0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text("Depth (cm)");

    // Add Season Graph X Axis
    season_graph.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + season_height + ")")
        .call(d3.axisBottom(seasonx)
            .ticks(d3.timeWeek.every(1))
            .tickFormat(d3.timeFormat("%m-%d")));

    // Add Season Graph Y0 Axis
    season_graph.append("g")
        .attr("class", "axisSteelBlue")
        .call(d3.axisLeft(seasony0));

    // Add Season Graph YBar Axis

    season_graph.append("g")
        .attr("class", "axisRed")
        .attr("transform", "translate( " + season_width + ", 0 )")
        .call(d3.axisRight(seasony1));

    /*************** legend ******************/

        var legend = season_graph.append("g")
          .attr("font-family", "sans-serif")
          .attr("font-size", 10)
          .attr("text-anchor", "end")
        .selectAll("g")
        .data(keys.slice().reverse())
        .enter().append("g")
          .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

      legend.append("rect")
          .attr("x", season_width - 17)
          .attr("width", 15)
          .attr("height", 15)
          .attr("fill", z)
          .attr("stroke", z)
          .attr("stroke-width",2)
          .on("click",function(d) { update(d) });

      legend.append("text")
          .attr("x", season_width - 24)
          .attr("y", 9.5)
          .attr("dy", "0.32em")
          .text(function(d) { return d; });


});
});
</script>

{% endblock content %}
